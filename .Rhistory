filter(studySub != "threshold_median")
res_museum <- rma(yi, vi, method = "DL", data = datM_museum)
forest(res_museum)
## For field - all snails
datM_field_all <- datM %>%
filter(museum == "field" & studySub == "threshold_none")
res_field <- rma(yi, vi, method = "DL", data = datM_field_all)
forest(res_field)
## For field - with size threshold
datM_field_threshold <- datM %>%
filter(museum == "field" & studySub == "threshold_median")
res_field_sub <- rma(yi, vi, method = "DL", data = datM_field_threshold)
forest(res_field_sub)
## Most appropriate subset
# Data, as is
datM_final <- rbind(datM_museum, datM_field_all)
res_final <- rma(yi, vi, method = "DL", data = datM_final)
forest(res_final)
# Include moderator
res_final2 <- rma(yi, vi, mods = museum01, method = "DL", data = datM_final)
res_final2
forest(res_final2)
res_final
?rma
View(datM_final)
# Include moderator
res_final2 <- rma(yi, vi, mods = museum01, method = "FE", data = datM_final)
res_final2
# Include moderator
res_final2 <- rma(yi, vi, mods = museum01, method = "REML", data = datM_final)
res_final2
forest(res_final2)
# Include moderator
res_final2 <- rma(yi, vi, mods = ~ museum, method = "REML", data = datM_final)
res_final2
forest(res_final2)
# Include moderator
res_final2 <- rma(yi, vi, mods = ~ museum01, method = "REML", data = datM_final)
res_final2
forest(res_final2)
# Include moderator
res_final2 <- rma(yi, vi, method = "REML", data = datM_final)
res_final2
forest(res_final2)
res_final2
## Most appropriate subset
# Data, as is
datM_final <- rbind(datM_museum, datM_field_all)
res <- rma(yi, vi, method = "DL", data = datM_final)
res
forest(res)
### set up 2x2 array for plotting
par(mfrow=c(2,2))
### draw funnel plots
funnel(res, main="Standard Error")
funnel(res, yaxis="vi", main="Sampling Variance")
funnel(res, yaxis="seinv", main="Inverse Standard Error")
funnel(res, yaxis="vinv", main="Inverse Sampling Variance")
### Forest plot
### decrease margins so the full space is used
par(mar=c(4,4,1,2))
datM_final
res <- rma(yi, vi, method = "DL", data = datM_final,
slab = study)
res
forest(res)
res <- rma(yi, vi, method = "DL", data = datM_final,
slab = paste(species2, study))
res
forest(res)
### Forest plot
### decrease margins so the full space is used
par(mar=c(4,4,1,2), mfrow = c(1,1))
forest(res)
res <- rma(yi, vi, method = "DL", data = datM_final,
slab = paste(species2, study, sep = ","))
res
### Forest plot
### decrease margins so the full space is used
par(mar=c(4,4,1,2), mfrow = c(1,1))
forest(res)
res <- rma(yi, vi, method = "DL", data = datM_final,
slab = paste(species2, study, sep = ", "))
res
### Forest plot
### decrease margins so the full space is used
par(mar=c(4,4,1,2), mfrow = c(1,1))
forest(res)
## Most appropriate subset
# Data, as is
datM_final <- rbind(datM_museum, datM_field_all) %>%
arrange(desc(latitude))
res <- rma(yi, vi, method = "DL", data = datM_final,
slab = paste(species2, study, sep = ", "))
res
### Forest plot
### decrease margins so the full space is used
par(mar=c(4,4,1,2), mfrow = c(1,1))
forest(res)
library(dplyr)
library(readr)
## Field surveys
hay_king <- read_csv("sbs_meta/scraped/HayfordKing_2017/Hayford-King_raw.csv")
hay_elahi <- read_csv("sbs_meta/scraped/HayfordElahi_2018/Hayford-Elahi_raw.csv")
gall_frank <- read_csv("sbs_meta/scraped/Galloway_2017/Galloway-Frank_raw.csv")
## Museum collections
sag <- read_csv("sbs_meta/scraped/Sagarin_2010/Sagarin_raw.csv")
wilson <- read_csv("sbs_meta/scraped/Wilson-Brodie_2017/Wilson-Brodie_raw.csv")
roy <- read_csv("sbs_meta/scraped/Roy2003_raw/Roy_raw.csv")
## Compile
master <- rbind(hay_king, hay_elahi, gall_frank, sag, wilson, roy)
master %>% count(study, year)
##### Integrate Elahi data #####
# Function to load cleaned data
source("R/choose_size_data.R")
# load data - approximated sizes
dat <- choose_size_data(method = "uniform")
dat2 <- dat %>%
select(-c(habitat, tideHTm_orig, sample_area_tidal_ht, size_prop, LL, Shaw_hab)) %>%
mutate(study = "Elahi2015",
studySub = NA,
size1mm_rand = size1mm)
master2 <- master %>%
mutate(year = lubridate::year(mdy(date)),
sampleArea = NA) %>%
select(-c(X1, habitat, Shaw_hab))
df <- rbind(master2, dat2)
# Remove where era is NA - i.e., for Roy data, keep only pre-1960 data
df <- df %>% filter(!is.na(era))
unique(df$study)
unique(df$species)
##### PRELIM ANALYSIS #####
library(lmer)
##### PRELIM ANALYSIS #####
library(lme4)
names(df)
df %>% count(study, year)
df %>% count(study, species, year)
View(df)
df %>% count(study, species, year) %>% print(n = 200)
# Select one year for Hayford-Elahi
hay_elahi %>% count(era, year)
hay_elahi <- hay_elahi %>% filter(year == 1969 | year == 2018)
## Field surveys
hay_king <- read_csv("sbs_meta/scraped/HayfordKing_2017/Hayford-King_raw.csv")
hay_elahi <- read_csv("sbs_meta/scraped/HayfordElahi_2018/Hayford-Elahi_raw.csv")
# Select one year for Hayford-Elahi past
hay_elahi %>% count(era, year)
hay_elahi <- hay_elahi %>% filter(year == 1969 | year == 2018)
gall_frank <- read_csv("sbs_meta/scraped/Galloway_2017/Galloway-Frank_raw.csv")
## Museum collections
sag <- read_csv("sbs_meta/scraped/Sagarin_2010/Sagarin_raw.csv")
wilson <- read_csv("sbs_meta/scraped/Wilson-Brodie_2017/Wilson-Brodie_raw.csv")
roy <- read_csv("sbs_meta/scraped/Roy2003_raw/Roy_raw.csv")
roy %>% count(species, era)
roy <- roy %>% filter(!is.na(era))
roy %>% count(species, era)
## Compile
master <- rbind(hay_king, hay_elahi, gall_frank, sag, wilson, roy)
master %>% count(study, year)
##### Integrate Elahi data #####
# Function to load cleaned data
source("R/choose_size_data.R")
# load data - approximated sizes
dat <- choose_size_data(method = "uniform")
dat2 <- dat %>%
select(-c(habitat, tideHTm_orig, sample_area_tidal_ht, size_prop, LL, Shaw_hab)) %>%
mutate(study = "Elahi2015",
studySub = NA,
size1mm_rand = size1mm)
master2 <- master %>%
mutate(year = lubridate::year(mdy(date)),
sampleArea = NA) %>%
select(-c(X1, habitat, Shaw_hab))
df <- rbind(master2, dat2)
df %>% count(study, species, year) %>% print(n = 200)
df %>% count(study, species, era) %>% print(n = 200)
mod1 <- lmer(size1mm ~ era + (1 | species), data = df)
summary(mod1)
mod1 <- lmer(log(size1mm) ~ era + (1 | species), data = df)
summary(mod1)
unique(df$species)
names(df)
mod1 <- lmer(log(size1mm) ~ era * lat + (1 | species), data = df)
summary(df)
unique(df$lat)
dat2 <- dat %>%
select(-c(habitat, tideHTm_orig, sample_area_tidal_ht,
size_prop, LL, Shaw_hab)) %>%
mutate(study = "Elahi2015",
studySub = NA,
size1mm_rand = size1mm)
unique(dat2$lat)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
fig2a <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2a.csv")
fig2a
fig2a <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2a.csv") %>%
mutate(figure = "fig2a")
fig2a
fig2a <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2a.csv") %>%
mutate(figure = "fig2a",
n = ifelse(era == "past", 219, 120))
fig2a
fig2a <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2a.csv") %>%
mutate(figure = "fig2a",
n = ifelse(era == "past", 219, 120))
fig2b <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2a.csv") %>%
mutate(figure = "fig2b",
n = ifelse(era == "past", 436, 256))
fig2a <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2a.csv") %>%
mutate(figure = "fig2a",
n = ifelse(era == "past", 219, 120))
fig2b <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2b.csv") %>%
mutate(figure = "fig2b",
n = ifelse(era == "past", 436, 256))
fig2c <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_2009_fig2c.csv") %>%
mutate(figure = "fig2c",
n = ifelse(era == "past", 498, 231))
dat <- rbind(fig2a, fig2b, fig2c)
dat
dat <- dat %>%
mutate(size1mm = round(size_bin, 0),
freq = proportion * n)
head(dat)
dat <- dat %>%
mutate(size1mm = round(size_bin, 0),
freq = round(proportion * n, 0))
head(dat)
# Sanity check - make sure that the means are similar to Figure 2
dat %>%
group_by(figure, era) %>%
summarise(mean(size1mm))
head(dat)
dat %>% count(size1mm)
dat %>% count(size1mm) %>% print(n = 30)
dat %>% count(era, size1mm) %>% print(n = 30)
dat %>% count(size1mm) %>% print(n = 30)
dat %>% count(size1mm) %>% print(n = 40)
# Now sum up across size bins within eras
fisher <- dat %>%
group_by(era, size1mm) %>%
summarise(n = sum(n))
fisher
View(dat)
# Now sum up across size bins within eras
fisher <- dat %>%
group_by(era, size1mm) %>%
summarise(freq = sum(freq))
View(fisher)
# Now sum up across size bins within eras
fisher <- dat %>%
group_by(era, size1mm) %>%
summarise(freq = sum(freq)) %>%
ungroup()
fisher_past <- fisher %>% filter(era == "past")
fisher_pres <- fisher %>% filter(era == "present")
n_present <- length(dat_present)
## Get raw sizes (use repeat sizes)
dat_present <- repeat_sizes(size_bin_vector = fisher_pres$size1mm,
count_vector = fisher_pres$freq)
n_present <- length(dat_present)
## Get raw sizes (use repeat sizes)
dat_present <- repeat_sizes(size_bin_vector = fisher_pres$size1mm,
count_vector = fisher_pres$freq)
source("R/convert_histo_to_raw.R")
## Get raw sizes (use repeat sizes)
dat_present <- repeat_sizes(size_bin_vector = fisher_pres$size1mm,
count_vector = fisher_pres$freq)
n_present <- length(dat_present)
dat_past <- repeat_sizes(size_bin_vector = fisher_past$size1mm,
count_vector = fisher_past$freq)
n_past <- length(dat_past)
fisher_past <- fig2c %>% filter(era == "past")
fisher_pres <- fig2c %>% filter(era == "present")
## Get raw sizes (use repeat sizes)
dat_present <- repeat_sizes(size_bin_vector = fisher_pres$size1mm,
count_vector = fisher_pres$freq)
n_present <- length(dat_present)
dat_past <- repeat_sizes(size_bin_vector = fisher_past$size1mm,
count_vector = fisher_past$freq)
n_past <- length(dat_past)
df_past <- data_frame(era = rep("past", n_past), size1mm = dat_past)
df_present <- data_frame(era = rep("present", n_present), size1mm = dat_present)
df <- rbind(df_past, df_present)
df
dat_present
fig2c
fisher_past <- fig2c %>% filter(era == "past")
# Now sum up across size bins within eras
fisher <- dat %>%
group_by(era, figure,  size1mm) %>%
summarise(freq = sum(freq)) %>%
ungroup()
# Now sum up across size bins within eras
fisher <- dat %>%
group_by(era, figure, size1mm) %>%
summarise(freq = sum(freq)) %>%
ungroup()
fisher
dat
fisher
dat
# Sanity check
fisher_past <- dat %>% filter(era == "past" & figure == "fig2c")
fisher_pres <- dat %>% filter(era == "present" & figure == "fig2c")
fisher_past
## Get raw sizes (use repeat sizes)
dat_present <- repeat_sizes(size_bin_vector = fisher_pres$size1mm,
count_vector = fisher_pres$freq)
n_present <- length(dat_present)
dat_past <- repeat_sizes(size_bin_vector = fisher_past$size1mm,
count_vector = fisher_past$freq)
n_past <- length(dat_past)
df_past <- data_frame(era = rep("past", n_past), size1mm = dat_past)
df_present <- data_frame(era = rep("present", n_present), size1mm = dat_present)
df <- rbind(df_past, df_present)
df
df %>%
group_by(era) %>%
summarise(mean(size1mm))
# All data
fisher_past <- fisher %>% filter(era == "past")
fisher_pres <- fisher %>% filter(era == "present")
## Get raw sizes (use repeat sizes)
dat_present <- repeat_sizes(size_bin_vector = fisher_pres$size1mm,
count_vector = fisher_pres$freq)
n_present <- length(dat_present)
dat_past <- repeat_sizes(size_bin_vector = fisher_past$size1mm,
count_vector = fisher_past$freq)
n_past <- length(dat_past)
df_past <- data_frame(era = rep("past", n_past), size1mm = dat_past)
df_present <- data_frame(era = rep("present", n_present), size1mm = dat_present)
df <- rbind(df_past, df_present)
df %>%
group_by(era) %>%
summarise(mean(size1mm))
df
df <- rbind(df_past, df_present)
df %>%
group_by(era) %>%
summarise(mean(size1mm))
df <- rbind(df_past, df_present) %>%
mutate(year = ifelse(era = "past", 1918, 2007))
df_past
df <- rbind(df_past, df_present) %>%
mutate(year = ifelse(era == "past", 1918, 2007))
dat <- data.frame(
study = "Fisher",
studySub = NA,
species = "Nucella lapillus",
sp = "NULP",
site = "Maine",
era = df$era,
date = NA,
nest1 = NA,
nest2 = NA,
nest3 = NA,
nest3note = NA,
sampleUnit = NA,
size1mm = df$size1mm,
size1mm_rand = df$size1mm,
habitat = NA,
tideHTm = NA,
lat = 44.2553654,
long = -68.36960568,
Shaw_hab = NA,
notes = "",
notes2 = "",
year = df$year
)
# Save this file
write.csv(dat, "sbs_meta/scraped/Fisher2009_raw/Fisher_raw.csv")
library(dplyr)
library(readr)
## Field surveys
hay_king <- read_csv("sbs_meta/scraped/HayfordKing_2017/Hayford-King_raw.csv")
hay_elahi <- read_csv("sbs_meta/scraped/HayfordElahi_2018/Hayford-Elahi_raw.csv")
# Select one year for Hayford-Elahi past
hay_elahi %>% count(era, year)
hay_elahi <- hay_elahi %>% filter(year == 1969 | year == 2018)
gall_frank <- read_csv("sbs_meta/scraped/Galloway_2017/Galloway-Frank_raw.csv")
## Museum collections
sag <- read_csv("sbs_meta/scraped/Sagarin_2010/Sagarin_raw.csv")
wilson <- read_csv("sbs_meta/scraped/Wilson-Brodie_2017/Wilson-Brodie_raw.csv")
fisher <- read_csv("sbs_meta/scraped/Fisher2009_raw/Fisher_raw.csv")
roy <- read_csv("sbs_meta/scraped/Roy2003_raw/Roy_raw.csv")
roy %>% count(species, era)
roy <- roy %>% filter(!is.na(era))
## Compile
master <- rbind(hay_king, hay_elahi, gall_frank, sag, wilson, fisher, roy)
master %>% count(study, year)
master %>% count(study, era)
# Function to load cleaned data
source("R/choose_size_data.R")
# load data - approximated sizes
dat <- choose_size_data(method = "uniform")
dat2 <- dat %>%
select(-c(habitat, tideHTm_orig, sample_area_tidal_ht,
size_prop, LL, Shaw_hab)) %>%
mutate(study = "Elahi2015",
studySub = NA,
size1mm_rand = size1mm)
master2 <- master %>%
mutate(year = lubridate::year(mdy(date)),
sampleArea = NA) %>%
select(-c(X1, habitat, Shaw_hab))
df <- rbind(master2, dat2)
##### PRELIM ANALYSIS #####
library(lme4)
names(df)
df %>% count(study, species, era) %>% print(n = 200)
mod1 <- lmer(log(size1mm) ~ era + (1 | species), data = df)
summary(mod1)
df %>%
ggplot(aes(era, size1mm_rand)) +
geom_violin() +
facet_wrap(~ species + study)
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_density(alpha = 0.5) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
ylab("Probability density") +
theme(legend.position = "top")
ggsave("sbs_meta/meta_figs/meta_density_era.pdf", height = 5, width = 7)
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_density(alpha = 0.5) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
ylab("Probability density") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram() +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
ylab("Probability density") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
#ylab("Proportion") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5, binwidth = 1) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
#ylab("Proportion") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5, binwidth = 2) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
#ylab("Proportion") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5, binwidth = 2,
y = ..density..) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
#ylab("Proportion") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5, binwidth = 2,
y = aes(..density..)) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
#ylab("Proportion") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5, binwidth = 2,
aes(y = ..density..)) +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
#ylab("Proportion") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era)) +
geom_histogram(alpha = 0.5, binwidth = 2,
aes(y = ..density..), position = "identity") +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
ylab("Density") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era, color = era)) +
geom_histogram(alpha = 0.5, binwidth = 2,
aes(y = ..density..), position = "identity") +
facet_wrap(~ study + species, scales = "free_y") +
xlab("Size (mm)") +
ylab("Density") +
theme(legend.position = "top")
df %>%
ggplot(aes(size1mm_rand, fill = era, color = era)) +
geom_histogram(alpha = 0.5, binwidth = 2,
aes(y = ..density..), position = "identity") +
facet_wrap(~ study + species, scales = "free_y", ncol = 3) +
xlab("Size (mm)") +
ylab("Density") +
theme(legend.position = "top")
ggsave("sbs_meta/meta_figs/meta_hist_era.pdf", height = 7, width = 7)
