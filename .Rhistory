min_C = min(monthly_mean),
cv_C = mean(monthly_cv))
# Get in long format
monthly_sstL <- elahi_sst_monthly %>% gather(key = metric, value = tempC, monthly_mean:monthly_cv)
sstL <- elahi_sst %>% gather(key = metric, value = tempC, mean_C:cv_C)
# Get median, and upper and lower values per year
head(sst_hms)
annual_quants <- sst_hms %>%  filter(year > 1937) %>% group_by(year) %>%
summarise(quantile_0.1 = quantile(tempC, 0.1),
quantile_0.5 = quantile(tempC, 0.5),
quantile_0.9 = quantile(tempC, 0.9)) %>%
ungroup()
aql <- annual_quants %>% gather(key = quantileValue, value = tempC, quantile_0.1:quantile_0.9)
source("03_identify_size_cutoff.R")
head(dat4)
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = "\\."))[1]) %>%
ungroup()
spYrs
head(dat4)
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = "\\ "))[1]) %>%
ungroup()
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
#mutate(genus = unlist(strsplit(species, split = "\\ "))[1]) %>%
ungroup()
spYrs
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = genus, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top")
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = " "))[1]) %>%
ungroup()
?strplit
?strsplit
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = "\\s+"))[1]) %>%
ungroup()
spYrs
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = " +"))[1]) %>%
ungroup()
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = " "), fixed = TRUE)[1]) %>%
ungroup()
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = " ", fixed = TRUE))[1]) %>%
ungroup()
spYrs
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = "\\s+", fixed = TRUE))[1]) %>%
ungroup()
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(species, split = " +", fixed = TRUE))[1]) %>%
ungroup()
spYrs
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = species, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top")
ggsave("figs/hms_temperature.png", height = 3.5, width = 3.5)
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = species, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top") +
theme(legend.key.size = unit(0.25, "cm"))
ggsave("figs/hms_temperature.png", height = 3.5, width = 3.5)
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = species, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top") +
theme(legend.key.size = unit(0.25, "cm")) +
theme(legend.text = element_text(size = 8))
ggsave("figs/hms_temperature.png", height = 3.5, width = 3.5)
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
theme_bw(base_size = 10) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = species, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top") +
theme(legend.key.size = unit(0.25, "cm")) +
theme(legend.text = element_text(size = 8))
ggsave("figs/hms_temperature.png", height = 3.5, width = 3.5)
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
theme_bw(base_size = 10) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = species, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top") +
theme(legend.key.size = unit(0.2, "cm")) +
theme(legend.text = element_text(size = 8))
ggsave("figs/hms_temperature.png", height = 3.5, width = 3.5)
crap <- "and one"
unlist(strsplit(crap, split = " +", fixed = TRUE))[1]
unlist(strsplit(crap, split = " +"))[1]
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species)
glimpse(spYrs)
crap <- as.factor("and one")
unlist(strsplit(crap, split = " +"))[1]
spYrs <- dat4 %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species) %>%
mutate(genus = unlist(strsplit(as.character(species), split = " +"))[1]) %>%
ungroup()
spYrs
glimpse(spYrs)
spYrs$genus <- factor(spYrs$genus, levels = c("Chlorostoma", "Lottia", "Littorina"))
glimpse(spYrs)
##### FINAL PLOTS #####
sstL %>% filter(metric != "cv_C") %>%
ggplot(aes(year, tempC, color = metric)) +
geom_line(alpha = 1) +
# theme_bw(base_size = 10) +
scale_color_manual(values = c("red", "black", "blue")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
geom_point(aes(x = year, y = 10, shape = genus, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top")
ggsave("figs/hms_temperature.png", height = 3.5, width = 3.5)
aql %>%
ggplot(aes(year, tempC, color = quantileValue)) +
geom_line(alpha = 1) +
#geom_point(alpha = 0.5) +
scale_color_manual(values = c("blue", "black", "red")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
# theme(legend.position = "none") +
geom_point(aes(x = year, y = 10, shape = species, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top")
# theme(legend.position = c(0,1), legend.justification = c(0,1)) +
aql %>%
ggplot(aes(year, tempC, color = quantileValue)) +
geom_line(alpha = 1) +
#geom_point(alpha = 0.5) +
scale_color_manual(values = c("blue", "black", "red")) +
# geom_smooth(method = "lm")  +
ylab(expression(paste("Temperature (", degree, "C)"))) +
xlab("Year") +
# theme(legend.position = "none") +
geom_point(aes(x = year, y = 10, shape = genus, color = NULL), data = spYrs,
alpha = 0.5, size = 3) +
guides(color = FALSE) +
theme(legend.title = element_blank()) +
theme(legend.position = "top")
ggsave("figs/hms_temp_quantiles.png", height = 3.5, width = 3.5)
glimpse(sst_hms)
glimpse(sst_hms)
get_hms_two_periods <- function(temp_df = sst_hms, size_data, duration = 10) {
nYrsPrior <- duration - 1
spYrs <- size_data %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadPres1 = floor(year2 - nYrsPrior),
hadPres2 = floor(year2),
hadPast1 = floor(year - nYrsPrior),
hadPast2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(year))
dat.i <- spYrs
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data)) %>%
select(-c(X, hadPres1:pres_data))
return(tempDat.i)
}
test1 <- dat4 %>% group_by(species) %>%
do(get_hms_two_periods(size_data = .)) %>% ungroup()
names(dat4)
names(sst_hms)
spYrs
get_hms_two_periods <- function(temp_df = sst_hms, size_data, duration = 10) {
nYrsPrior <- duration - 1
spYrs <- size_data %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadPres1 = floor(year2 - nYrsPrior),
hadPres2 = floor(year2),
hadPast1 = floor(year - nYrsPrior),
hadPast2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(year))
dat.i <- spYrs %>% mutate(study = "Elahi2015")
temp_df <- temp_df %>% mutate(study = "Elahi2015")
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data)) %>%
select(-c(X, hadPres1:pres_data))
return(tempDat.i)
}
test1 <- dat4 %>% group_by(species) %>%
do(get_hms_two_periods(size_data = .)) %>% ungroup()
dat4
head(dat4)
get_hms_two_periods <- function(temp_df = sst_hms, size_data, duration = 10) {
nYrsPrior <- duration - 1
# is there a study column in the size_data?
if(!"study" %in% colnames(size_data)) {
size_data$study <- "Elahi2015"
}
spYrs <- size_data %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadPres1 = floor(year2 - nYrsPrior),
hadPres2 = floor(year2),
hadPast1 = floor(year - nYrsPrior),
hadPast2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(year))
dat.i <- spYrs
temp_df <- temp_df %>% mutate(study = "Elahi2015")
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data)) %>%
select(-c(X, hadPres1:pres_data))
return(tempDat.i)
}
test1 <- dat4 %>% group_by(species) %>%
do(get_hms_two_periods(size_data = .)) %>% ungroup()
head(dat4)
temp_df = sst_hms
size_data = dat4
duration = 10
nYrsPrior <- duration - 1
head(size_data)
if(!"study" %in% colnames(size_data)) {
size_data$study <- "Elahi2015"
}
names(size_data)
size_data %>% select(species, year) %>% distinct() %>%
arrange(species, year) %>%
group_by(species)
size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present", 3)))
size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present"), 3))
size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present"), 3)) %>%
spread(key = era, value = year)
size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present"), 3)) %>%
spread(key = era, value = year) %>%
mutate(hadPres1 = floor(present - nYrsPrior),
hadPres2 = floor(present),
hadPast1 = floor(past - nYrsPrior),
hadPast2 = floor(present))
size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present"), 3)) %>%
spread(key = era, value = year) %>%
mutate(hadPres1 = floor(present - nYrsPrior),
hadPres2 = floor(present),
hadPast1 = floor(past - nYrsPrior),
hadPast2 = floor(past))
spYrs <- size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present"), 3)) %>%
spread(key = era, value = year) %>%
mutate(hadPres1 = floor(present - nYrsPrior),
hadPres2 = floor(present),
hadPast1 = floor(past - nYrsPrior),
hadPast2 = floor(past))
dat.i <- spYrs
temp_df
head(temp_df)
temp_df <- temp_df %>% mutate(study = "Elahi2015")
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data)) %>%
select(-c(X, hadPres1:pres_data))
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data))
View(tempDat.i)
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data)) %>%
select(-c(hadPres1:pres_data))
tempDat.i
get_hms_two_periods <- function(temp_df = sst_hms, size_data, duration = 10) {
nYrsPrior <- duration - 1
# is there a study column in the size_data?
if(!"study" %in% colnames(size_data)) {
size_data$study <- "Elahi2015"
}
spYrs <- size_data %>% select(study, species, year) %>% distinct() %>%
arrange(species, year) %>%
mutate(era = rep(c("past", "present"), 3)) %>%
spread(key = era, value = year) %>%
mutate(hadPres1 = floor(present - nYrsPrior),
hadPres2 = floor(present),
hadPast1 = floor(past - nYrsPrior),
hadPast2 = floor(past))
dat.i <- spYrs
temp_df <- temp_df %>% mutate(study = "Elahi2015")
tempDat.i <- inner_join(temp_df, dat.i, by = "study") %>%
mutate(past_data = ifelse(year >= hadPast1 & year <= hadPast2,
"past", NA),
pres_data = ifelse(year >= hadPres1 & year <= hadPres2,
"pres", NA)) %>%
filter(!is.na(past_data) | !is.na(pres_data)) %>%
mutate(era = ifelse(is.na(past_data), "present", past_data)) %>%
select(-c(hadPres1:pres_data))
return(tempDat.i)
}
test1 <- dat4 %>% group_by(species) %>%
do(get_hms_two_periods(size_data = .)) %>% ungroup()
temp_period_dat <- get_hms_two_periods(size_data = dat4)
names(temp_period_dat)
temp_period_dat %>%
ggplot(aes(species, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE)
dodge <- position_dodge(width = 0.9)
temp_period_dat %>%
ggplot(aes(species, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ species)
temp_period_dat %>%
ggplot(aes(species, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE)
head(temp_period_dat)
temp_monthly <- temp_period_dat %>% group_by(era, year, month) %>%
summarise(monthly_mean = mean(tempC),
monthly_max = max(tempC),
monthly_min = min(tempC),
monthly_sd = sd(tempC),
monthly_cv = monthly_sd/monthly_mean * 100) %>%
mutate(dateR = ymd(paste(year, month, 15, sep = "-"))) %>%
ungroup()
temp_monthly
temp_monthlyL <- temp_monthly %>% gather(key = metric, value = tempC,
monthly_mean:monthly_cv)
temp_monthly
temp_monthly <- temp_period_dat %>% group_by(species, era, year, month) %>%
summarise(monthly_mean = mean(tempC),
monthly_max = max(tempC),
monthly_min = min(tempC),
monthly_sd = sd(tempC),
monthly_cv = monthly_sd/monthly_mean * 100) %>%
mutate(dateR = ymd(paste(year, month, 15, sep = "-"))) %>%
ungroup()
temp_monthly
temp_monthlyL <- temp_monthly %>% gather(key = metric, value = tempC,
monthly_mean:monthly_cv)
temp_monthlyL
temp_monthlyL %>%
ggplot(aes(species, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ metric)
temp_monthly
temp_monthlyL <- temp_monthly %>% gather(key = metric, value = tempC,
monthly_mean:monthly_min)
temp_monthlyL
temp_monthlyL %>%
ggplot(aes(species, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ metric)
temp_monthlyL %>%
ggplot(aes(metric, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ species)
temp_monthly
temp_annual <- temp_monthly %>%
group_by(year) %>%
summarise(mean_C = mean(monthly_mean),
max_C = max(monthly_mean),
min_C = min(monthly_mean),
cv_C = mean(monthly_cv))
temp_annual
temp_annualL <- temp_annual %>% gather(key = metric, value = tempC, mean_C:cv_C)
temp_annual <- temp_monthly %>%
group_by(species, year) %>%
summarise(mean_C = mean(monthly_mean),
max_C = max(monthly_mean),
min_C = min(monthly_mean),
cv_C = mean(monthly_cv))
View(temp_annual)
temp_annualL <- temp_annual %>% gather(key = metric, value = tempC, mean_C:cv_C)
temp_annual <- temp_monthly %>%
group_by(species, era, year) %>%
summarise(mean_C = mean(monthly_mean),
max_C = max(monthly_mean),
min_C = min(monthly_mean),
cv_C = mean(monthly_cv))
temp_annualL <- temp_annual %>% gather(key = metric, value = tempC, mean_C:cv_C)
temp_annualL %>%
ggplot(aes(metric, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ species)
temp_annualL %>%
ggplot(aes(metric, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = FALSE) +
facet_wrap(~ species)
temp_annualL <- temp_annual %>% gather(key = metric, value = tempC, mean_C:min_C)
temp_annualL %>%
ggplot(aes(metric, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = FALSE) +
facet_wrap(~ species)
# Daily temperature comparison
temp_period_dat %>%
ggplot(aes(species, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE)
temp_monthlyL %>%
ggplot(aes(metric, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ species)
temp_monthlyL %>%
ggplot(aes(metric, tempC, fill = era)) +
geom_boxplot(position = dodge, notch = TRUE) +
facet_wrap(~ species)
ggsave("figs/hms_temp_era.png", height = 3.5, width = 7)
