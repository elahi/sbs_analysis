mutate(delta_year = abs(year2 - year),
delta_size = size_rep2 - size_rep,
delta_size_yr = delta_size/delta_year)
dat4 %>%
ggplot(aes(delta_year, delta_size, color = species, shape = study)) +
geom_point()
dat4 %>%
ggplot(aes(delta_year, delta_size, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3)
dat4 <- dat3 %>%
mutate(delta_year = abs(year2 - year),
delta_size = size_rep2 - size_rep,
delta_size_yr = delta_size/delta_year)
dat4 %>%
ggplot(aes(delta_year, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3)
dat4 %>%
ggplot(aes(species, delta_size_yr, shape = study)) +
geom_point(alpha = 0.5, size = 3)
dat4 %>%
ggplot(aes(species, delta_size_yr, shape = study)) +
geom_point(alpha = 0.5, size = 3) + coord_flip()
dat4 %>%
ggplot(aes(species, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3) + coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed", color = "gray")
dat4 <- dat3 %>%
mutate(delta_year = year - year2,
delta_size = size_rep - size_rep2,
delta_size_yr = delta_size/delta_year)
dat4 %>%
ggplot(aes(delta_year, delta_size, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3)
dat4 %>%
ggplot(aes(delta_year, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3)
dat4 %>%
ggplot(aes(species, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3) + coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed", color = "gray")
dat4 %>%
ggplot(aes(delta_year, delta_size, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3)
dat4 %>%
ggplot(aes(delta_year, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3) +
geom_hline(yintercept = 0, linetype = "dashed", color = "gray")
dat4 %>%
ggplot(aes(species, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3) + coord_flip() +
geom_hline(yintercept = 0, linetype = "dashed", color = "gray")
dat4 %>%
ggplot(aes(delta_year, delta_size_yr, color = species, shape = study)) +
geom_point(alpha = 0.5, size = 3) +
geom_hline(yintercept = 0, linetype = "dashed", color = "gray")
View(dat4)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
theme_set(theme_bw(base_size = 12))
library(lubridate)
library(raster)
library(xts)
library(caTools)
# Get coordinates for each study
dat <- read.csv("sbs_meta/hadisst/sbs_hadisst_gps.csv")
dat
###### PREPARE SST DATA #####
## Function from Jillian Dunic
load_hadsst <- function(file = "../bigFiles/HadISST_sst.nc") {
b <- raster::brick(file)
raster::NAvalue(b) <- -1000
return(b)
}
sst <- load_hadsst()
names(sst)
Date <- substr(names(sst), 2, 11)
Date
Date <- gsub('\\.', '\\-', Date)
Date <- as.Date(Date)
head(Date)
###### EXTRACT TEMPERATURES FOR EACH SET OF COORDINATES #####
dat
study <- unique(dat$study)
i = 1
study.i <- study[i]
dat.i <- dat %>% filter(study == study.i)
tserie.i <- as.vector(extract(sst, cbind(dat.i$hadLong, dat.i$hadLat)))
df.i <- data.frame(Date, tserie.i) %>%
mutate(study = study.i)
tserie.df <- df.i
tserie.df %>%
mutate(runMean = runmean(tserie.i, 12)) %>%
ggplot(aes(Date, tserie.i)) + geom_line(col = "gray") +
geom_line(aes(Date, runMean), col = "red") %>%
facet_wrap(~ study)
## Repeat for other studies
for(i in 2:length(study)){
study.i <- study[i]
dat.i <- dat %>% filter(study == study.i)
tserie.i <- as.vector(extract(sst, cbind(dat.i$hadLong, dat.i$hadLat)))
df.i <- data.frame(Date, tserie.i) %>%
mutate(study = study.i)
tserie.df <- rbind(tserie.df, df.i)
}
# Rename and calculate moving average (12-month)
dfHad <- tserie.df %>% group_by(study) %>%
mutate(Moving_average_C = runmean(tserie.i, 12),
Year = year(Date)) %>%
ungroup() %>%
rename(Temperature_C = tserie.i) %>%
inner_join(., dat, by = "study")
dfHad
# Combine
dfAnnual <- dfHad %>% group_by(study, Year) %>%
summarise(mean_C = mean(Temperature_C),
max_C = max(Temperature_C),
min_C = min(Temperature_C),
hadYear1 = mean(hadYear1),
hadYear2 = mean(hadYear2)) %>%
ungroup()
dfAnnL <- gather(dfAnnual, key = metric, value = Temperature_C,
mean_C:min_C)
glimpse(dfAnnL)
###### PLOT COMPLETE TRENDS #####
dat
dfHad %>%
ggplot(aes(Date, Moving_average_C, col = study)) + geom_line()
dfAnnL %>%
ggplot(aes(Year, Temperature_C, col = metric)) +
geom_line(alpha = 0.5) +
facet_wrap(~ study) +
geom_vline(aes(xintercept = hadYear1), linetype = "dashed") +
geom_vline(aes(xintercept = hadYear2), linetype = "dashed") +
geom_smooth(span = 0.1)
dfHad
write.csv(dfHad, "sbs_meta/output/dfHad.csv")
dfHad %>% select(Date, Temperature_C, Year, hadLong, hadLat) %>%
write.csv(., "sbs_meta/output/dfHad.csv")
dfHad %>% dplyr::select(Date, Temperature_C, Year, hadLong, hadLat) %>%
write.csv(., "sbs_meta/output/dfHad.csv")
dfHad %>% dplyr::select(study, Date, Temperature_C, Year, hadLong, hadLat) %>%
write.csv(., "sbs_meta/output/dfHad.csv")
?select
detach("package:raster", unload=TRUE)
dfHad %>% :select(study, Date, Temperature_C, Year, hadLong, hadLat) %>%
dfHad %>% select(study, Date, Temperature_C, Year, hadLong, hadLat) %>%
write.csv(., "sbs_meta/output/dfHad.csv")
dfHad <- read.csv("sbs_meta/output/dfHad.csv")
head(dfHad)
head(dat4)
spYrs <- dat4 %>% select(study, species, year, year2)
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct()
spYrs
ceiling(2.1)
floor(10.1)
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year - 10),
hadYr2 = floor(year2 - 10))
spYrs
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2 - 10),
hadYr2 = floor(year))
spYrs
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2 - 10),
hadYr2 = floor(year)) %>%
group_by(study, species) %>% slice(1)
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
species.i
dat.i <- dat %>% filter(species == species.i)
dat.i <- spYrs %>% filter(species == species.i)
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2 - 10),
hadYr2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup()
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
dat.i
dat.i <- spYrs %>% filter(species == species.i) %>% select(-year, -year2)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study")
datHad.i
head(datHad.i)
dat.i <- spYrs %>% filter(species == species.i)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate()
datHad.i
head(datHad.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove"))
head(datHad.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep")
head(datHad.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
head(datHad.i)
datHad <- datHad.i
spYrs
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2 - 10),
hadYr2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(hadYr2))
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
head(datHad.i)
datHad <- datHad.i
for(i in 2:length(species)){
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
datHad <- rbind(datHad, datHad.i)
}
datHad %>%
ggplot(aes(Date, Moving_average_C, col = species)) + geom_line()
datHad2 <- datHad %>% group_by(species) %>%
mutate(Moving_average_C = runmean(Temperature_C, 12))
datHad2 %>%
ggplot(aes(Date, Moving_average_C, col = species)) + geom_line()
head(datHad2)
datHad2 <- datHad %>% group_by(species) %>%
mutate(Moving_average_C = runmean(Temperature_C, 12),
Date = ymd(Date))
head(datHad2)
datHad2 %>%
ggplot(aes(Date, Moving_average_C, col = species)) + geom_line()
datHad2 %>%
ggplot(aes(Date, Temperature_C, col = species)) + geom_line()
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean12 = runmean(Temperature_C, 12),
runMean60 = runmean(Temperature_C, 60),
Date = ymd(Date))
datHad2 %>%
ggplot(aes(Date, runMean60, col = species)) + geom_line()
datHad2 %>%
ggplot(aes(Date, runMean60, col = species)) +
geom_line() +
geom_line(aes(Date, runmean12, col = species), linetype = "dashed")
datHad2 %>%
ggplot(aes(Date, runMean60, col = species)) +
geom_line() +
geom_line(aes(Date, runMean12, col = species), linetype = "dashed")
datHad2 %>%
ggplot(aes(Date, runMean12, col = species)) +
geom_line() +
datHad2 %>%
ggplot(aes(Date, runMean12, col = species)) +
geom_line()
datHad2 %>%
ggplot(aes(Date, runMean12, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_grid(species ~ study)
datHad2 %>%
ggplot(aes(Date, runMean12, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
datHad2
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean12 = runmean(Temperature_C, 12),
runMean60 = runmean(Temperature_C, 60),
Date = ymd(Date)) %>%
ungroup()
dfAnnual <- datHad2 %>% group_by(study, species, Year) %>%
summarise(mean_C = mean(Temperature_C),
max_C = max(Temperature_C),
min_C = min(Temperature_C)) %>%
ungroup()
dfAnnL <- gather(dfAnnual, key = metric, value = Temperature_C,
mean_C:min_C)
glimpse(dfAnnL)
dfAnnL %>%
ggplot(aes(Year, Temperature_C, col = metric)) +
geom_line(alpha = 0.5) +
facet_wrap(~ study + species) +
geom_smooth(span = 0.1)
dfAnnL %>%
ggplot(aes(Year, Temperature_C, col = metric)) +
geom_line(alpha = 0.5) +
facet_wrap(~ study + species) +
geom_smooth(method = "lm")
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2),
hadYr2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(hadYr2))
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
"keep", "remove")) %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
filter(species1 == "keep") %>% select(-c(X, species1))
head(datHad.i)
datHad <- datHad.i
for(i in 2:length(species)){
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
datHad <- rbind(datHad, datHad.i)
}
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean12 = runmean(Temperature_C, 12),
runMean60 = runmean(Temperature_C, 60),
Date = ymd(Date)) %>%
ungroup()
head(datHad2)
ggplot(aes(Date, runMean12, col = species)) +
datHad2 %>%
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
##### CALCULATE HADISST SUMMARY METRICS PER SPECIES #####
# Combine
dfAnnual <- datHad2 %>% group_by(study, species, Year) %>%
summarise(mean_C = mean(Temperature_C),
max_C = max(Temperature_C),
min_C = min(Temperature_C)) %>%
ungroup()
dfAnnL <- gather(dfAnnual, key = metric, value = Temperature_C,
mean_C:min_C)
glimpse(dfAnnL)
dfAnnL %>%
ggplot(aes(Year, Temperature_C, col = metric)) +
geom_line(alpha = 0.5) +
facet_wrap(~ study + species) +
geom_smooth(method = "lm")
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
head(datHad.i)
datHad <- datHad.i
for(i in 2:length(species)){
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
datHad <- rbind(datHad, datHad.i)
}
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean12 = runmean(Temperature_C, 12),
runMean60 = runmean(Temperature_C, 60),
Date = ymd(Date)) %>%
ungroup()
head(datHad2)
datHad2 %>%
ggplot(aes(Date, runMean12, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2-10),
hadYr2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(hadYr2))
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
head(datHad.i)
datHad <- datHad.i
for(i in 2:length(species)){
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
datHad <- rbind(datHad, datHad.i)
}
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean12 = runmean(Temperature_C, 12),
runMean60 = runmean(Temperature_C, 60),
Date = ymd(Date)) %>%
ungroup()
head(datHad2)
datHad2 %>%
ggplot(aes(Date, runMean12, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean12 = runmean(Temperature_C, 12),
runMean60 = runmean(Temperature_C, 12*10),
Date = ymd(Date)) %>%
ungroup()
head(datHad2)
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean1 = runmean(Temperature_C, 12),
runMean10 = runmean(Temperature_C, 12*10),
Date = ymd(Date)) %>%
ungroup()
head(datHad2)
datHad2 %>%
ggplot(aes(Date, runMean10, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
datHad2 %>%
ggplot(aes(Date, runMean1, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
spYrs <- dat4 %>% select(study, species, year, year2) %>%
distinct() %>%
mutate(hadYr1 = floor(year2),
hadYr2 = floor(year)) %>%
group_by(study, species) %>% slice(1) %>%
ungroup() %>% filter(!is.na(hadYr2))
spYrs
species <- unique(spYrs$species)
i = 1
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
dat.i
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
head(datHad.i)
datHad <- datHad.i
for(i in 2:length(species)){
species.i <- species[i]
dat.i <- spYrs %>% filter(species == species.i)
datHad.i <- inner_join(dfHad, dat.i, by = "study") %>%
mutate(species1 = ifelse(Year >= hadYr1 & Year <= hadYr2,
"keep", "remove")) %>%
filter(species1 == "keep") %>% select(-c(X, species1))
datHad <- rbind(datHad, datHad.i)
}
datHad2 <- datHad %>% group_by(species) %>%
mutate(runMean1 = runmean(Temperature_C, 12),
runMean10 = runmean(Temperature_C, 12*10),
Date = ymd(Date)) %>%
ungroup()
head(datHad2)
datHad2 %>%
ggplot(aes(Date, runMean1, col = species)) +
geom_line() +
geom_smooth(method = "lm") +
facet_wrap(~ study + species)
dfAnnual <- datHad2 %>% group_by(study, species, Year) %>%
summarise(mean_C = mean(Temperature_C),
max_C = max(Temperature_C),
min_C = min(Temperature_C)) %>%
ungroup()
dfAnnL <- gather(dfAnnual, key = metric, value = Temperature_C,
mean_C:min_C)
glimpse(dfAnnL)
dfAnnL %>%
ggplot(aes(Year, Temperature_C, col = metric)) +
geom_line(alpha = 0.5) +
facet_wrap(~ study + species) +
geom_smooth(method = "lm")
dfAnnL
